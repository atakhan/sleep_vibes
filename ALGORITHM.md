# Алгоритм процедурной генерации звука и анимации

## Как я понял алгоритм:

### 1. **Структура сессии засыпания**

Сессия состоит из двух слоев звука:
- **Ритмичный звук (основной)** - короткие удары, синхронизированные с анимацией
- **Фоновый эмбиент** - непрерывный тихий звук на основе температуры

### 2. **Ритмичный звук и анимация (синхронизация)**

#### Базовый ритм:
- Начальный BPM: **65 ударов в минуту**
- Каждый удар = короткий звук (0.1 сек) + анимация пульса

#### Алгоритм синхронизации:
```
1. Запускаем первый удар сразу
2. Вычисляем интервал до следующего удара: interval = (60 / currentBPM) * 1000 мс
3. Через interval мс:
   - Воспроизводим звук удара (oscillator с коротким fade in/out)
   - Запускаем CSS анимацию beat-pulse на элементе анимации
   - Планируем следующий удар (рекурсивно вызываем scheduleNextBeat)
```

#### Угасание ритма:
- Используется **экспоненциальная функция**: `BPM = baseBPM - (bpmRange * progress^0.7)`
- Начало: 65 BPM
- Конец: 40 BPM
- Кривая угасания: более быстрое угасание в начале, медленное в конце

### 3. **Фоновый эмбиент**

#### Процедурная генерация:
- Генерируется через **ScriptProcessorNode** (Web Audio API)
- Типы: белый шум, розовый шум, коричневый шум
- Громкость: тихая (30% от базовой), уменьшается по мере прогресса сессии
- Непрерывный, не синхронизирован с ритмом

#### Алгоритм генерации:
```
Для каждого аудио буфера (4096 сэмплов):
  1. Генерируем случайный шум (в зависимости от типа)
  2. Применяем фильтры (для розового/коричневого шума)
  3. Умножаем на громкость эмбиента (учитывая прогресс сессии)
  4. Выводим в аудио поток
```

### 4. **Анимация**

#### Процедурная генерация:
- Генерируется на основе типа анимации (волны, частицы, градиент)
- Параметры зависят от температуры (цвет, скорость, интенсивность)

#### Синхронизация с ритмом:
```
При каждом ударе ритма:
  1. Добавляем класс 'beat-pulse' к элементу анимации
  2. CSS анимация beatPulse:
     - Масштабирование: 1.0 → 1.05 → 1.0
     - Яркость: 1.0 → 1.2 → 1.0
  3. Через 200мс убираем класс
```

### 5. **Длина сессии**

Зависит от температуры:
- **Формула**: `duration = baseDuration * (1 - temperature/200)`
- При temp=0: 10 минут
- При temp=100: 5 минут
- Чем меньше температура → длиннее сессия

### 6. **Проблемы, которые были исправлены:**

1. **session_info пустой**:
   - Проблема: элементы не были найдены в DOM при первом вызове
   - Решение: добавлена проверка существования элементов и задержка 100мс

2. **Звук непрерывный**:
   - Проблема: эмбиент был слишком громким, ритмичный звук не был заметен
   - Решение: уменьшена громкость эмбиента до 30%, исправлен clearTimeout вместо clearInterval

## Визуализация алгоритма:

```
Время сессии (0% → 100%)
│
├─ Ритмичный звук (основной):
│  ├─ Удар 1 (65 BPM) ──┐
│  ├─ Удар 2 (64 BPM)   │ Синхронизировано
│  ├─ Удар 3 (63 BPM)   │ с анимацией
│  └─ ... (угасание)    │
│                       │
├─ Фоновый эмбиент:     │
│  └─ Непрерывный шум   │ Не синхронизирован
│     (тихий, 30%)      │
│                       │
└─ Анимация:            │
   └─ Пульсация при     │
      каждом ударе      ┘
```

## Ключевые моменты:

1. **Ритм угасает плавно** - экспоненциальная функция обеспечивает естественное замедление
2. **Синхронизация точная** - звук и анимация запускаются одновременно через setTimeout
3. **Эмбиент не мешает** - тихий фоновый звук создает атмосферу, не перебивая ритм
4. **Процедурная генерация** - все параметры вычисляются динамически на основе температуры и прогресса

